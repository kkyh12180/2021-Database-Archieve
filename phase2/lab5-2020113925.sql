--2020113925
--Lab #5-1 and Lab #5-2
CREATE TABLE EMPLOYEE (
	Fname 			VARCHAR(15) 	NOT NULL,
	Minit 			CHAR,
	Lname 			VARCHAR(15) 	NOT NULL,
	Ssn 			CHAR(9)  		NOT NULL,
	Bdate 			DATE,
	Address 		VARCHAR(30),
	Sex 			CHAR,
	Salary 			DECIMAL(10, 2),
	Super_ssn	 	CHAR(9),
	Dno		 		INT		 		DEFAULT 1 NOT NULL,
	PRIMARY KEY (Ssn)
	);

CREATE TABLE DEPARTMENT (
	Dname 			VARCHAR(15) 	NOT NULL,
	Dnumber 		INT		 		NOT NULL,
	Mgr_ssn 		CHAR(9)	 		DEFAULT '888665555' NOT NULL,
	Mgr_start_date 	DATE,
	PRIMARY KEY (Dnumber),
	UNIQUE (Dname),
	FOREIGN KEY (Mgr_ssn) REFERENCES EMPLOYEE(Ssn)
	);

CREATE TABLE DEPT_LOCATIONS (
	Dnumber 		INT 			NOT NULL,
	Dlocation 		VARCHAR(15) 	NOT NULL,
	PRIMARY KEY (Dnumber, Dlocation),
	FOREIGN KEY (Dnumber) REFERENCES DEPARTMENT(Dnumber)
	);

CREATE TABLE PROJECT (
	Pname 			VARCHAR(15)	 	NOT NULL,
	Pnumber	 		INT			 	NOT NULL,
	Plocation 		VARCHAR(15),
	Dnum	 		INT			 	NOT NULL,
	PRIMARY KEY (Pnumber),
	UNIQUE (Pname),
	FOREIGN KEY (Dnum) REFERENCES DEPARTMENT(Dnumber)
	);

CREATE TABLE WORKS_ON (
	Essn	 		CHAR(9)	 		NOT NULL,
	Pno		 		INT		 		NOT NULL,
	Hours		 	DECIMAL(3, 1),
	PRIMARY KEY (Essn, Pno),
	FOREIGN KEY (Essn) REFERENCES EMPLOYEE(Ssn),
	FOREIGN KEY (Pno) REFERENCES PROJECT(Pnumber)
	);

CREATE TABLE DEPENDENT (
	Essn	 		CHAR(9)	 		NOT NULL,
	Dependent_name 	VARCHAR(15)	 	NOT NULL,
	Sex			 	CHAR,
	Bdate		 	DATE,
	Relationship 	VARCHAR(8),
	PRIMARY KEY (Essn, Dependent_name),
	FOREIGN KEY (Essn) REFERENCES EMPLOYEE(Ssn)
	);

--INSERT VALUES INTO EMPLOYEE 
INSERT INTO EMPLOYEE VALUES('John', 'B', 'Smith', '123456789', TO_DATE('1965-01-09', 'yyyy-mm-dd'), '731 Fordren, Houston, TX', 'M', 30000, '333445555', 5);
INSERT INTO EMPLOYEE VALUES('Franklin', 'T', 'Wong', '333445555', TO_DATE('1955-12-08', 'yyyy-mm-dd'), '638 Voss, Houston, TX', 'M', 40000, '888665555', 5);
INSERT INTO EMPLOYEE VALUES('Alicia', 'J', 'Zelaya', '999887777', TO_DATE('1968-01-19', 'yyyy-mm-dd'), '3321 Castle, Spring, TX', 'F', 25000, '987654321', 4);
INSERT INTO EMPLOYEE VALUES('Jennifer', 'S', 'Wallace', '987654321', TO_DATE('1941-06-20', 'yyyy-mm-dd'), '291 Berry, Bellaire, TX', 'F', 43000, '888665555', 4);
INSERT INTO EMPLOYEE VALUES('Ramesh', 'K', 'Narayan', '666884444', TO_DATE('1962-09-15', 'yyyy-mm-dd'), '975 Fire Oak, Humble, TX', 'M', 38000, '333445555', 5);
INSERT INTO EMPLOYEE VALUES('Joyce', 'A', 'English', '453453453', TO_DATE('1972-07-31', 'yyyy-mm-dd'), '5631 Rice, Houston, TX', 'F', 25000, '333445555', 5);
INSERT INTO EMPLOYEE VALUES('Ahmad', 'V', 'Jabbar', '987987987', TO_DATE('1969-03-29', 'yyyy-mm-dd'), '980 Dallas, Houston, TX', 'M', 25000, '987654321', 4);
INSERT INTO EMPLOYEE VALUES('James', 'E', 'Borg', '888665555', TO_DATE('1937-11-10', 'yyyy-mm-dd'), '450 Stone, Houston, TX', 'M', 55000, null, 1);

--INSERT VALUES INTO DEPARTMENT
INSERT INTO DEPARTMENT VALUES('Research', 5, '333445555', TO_DATE('1988-05-22', 'yyyy-mm-dd'));
INSERT INTO DEPARTMENT VALUES('Administration', 4, '987654321', TO_DATE('1995-01-01', 'yyyy-mm-dd'));
INSERT INTO DEPARTMENT VALUES('Headquarters', 1, '888665555', TO_DATE('1981-06-19', 'yyyy-mm-dd'));

--FOREIGN KEY CONSTANT
ALTER TABLE EMPLOYEE ADD FOREIGN KEY (Super_ssn) REFERENCES EMPLOYEE(Ssn);
ALTER TABLE EMPLOYEE ADD FOREIGN KEY (Dno) REFERENCES DEPARTMENT(Dnumber);

--INSERT VALUES INTO DEPT_LOCATIONS
INSERT INTO DEPT_LOCATIONS VALUES(1, 'Houston');
INSERT INTO DEPT_LOCATIONS VALUES(4, 'Stafford');
INSERT INTO DEPT_LOCATIONS VALUES(5, 'Bellaire');
INSERT INTO DEPT_LOCATIONS VALUES(5, 'Sugarland');
INSERT INTO DEPT_LOCATIONS VALUES(5, 'Houston');

--INSERT VALUES INTO PROJECT
INSERT INTO PROJECT VALUES('ProductX', 1, 'Bellaire', 5);
INSERT INTO PROJECT VALUES('ProductY', 2, 'Sugarland', 5);
INSERT INTO PROJECT VALUES('ProductZ', 3, 'Houston', 5);
INSERT INTO PROJECT VALUES('Computerization', 10, 'Stafford', 4);
INSERT INTO PROJECT VALUES('Reorgaization', 20, 'Houston', 1);
INSERT INTO PROJECT VALUES('Newbenefits', 30, 'Stafford', 4);

--INSERT VALUES INTO WORKS_ON
INSERT INTO WORKS_ON VALUES('123456789', 1, '32.5');
INSERT INTO WORKS_ON VALUES('123456789', 2, '7.5');
INSERT INTO WORKS_ON VALUES('666884444', 3, '40.0');
INSERT INTO WORKS_ON VALUES('453453453', 1, '20.0');
INSERT INTO WORKS_ON VALUES('453453453', 2, '20.0');
INSERT INTO WORKS_ON VALUES('333445555', 2, '10.0');
INSERT INTO WORKS_ON VALUES('333445555', 3, '10.0');
INSERT INTO WORKS_ON VALUES('333445555', 10, '10.0');
INSERT INTO WORKS_ON VALUES('333445555', 20, '10.0');
INSERT INTO WORKS_ON VALUES('999887777', 30, '30.0');
INSERT INTO WORKS_ON VALUES('999887777', 10, '10.0');
INSERT INTO WORKS_ON VALUES('987987987', 10, '35.0');
INSERT INTO WORKS_ON VALUES('987987987', 30, '5.0');
INSERT INTO WORKS_ON VALUES('987654321', 30, '20.0');
INSERT INTO WORKS_ON VALUES('987654321', 20, '15.0');
INSERT INTO WORKS_ON VALUES('888665555', 20, NULL);

--INSERT VALUES INTO DEPENDENT
INSERT INTO DEPENDENT VALUES('333445555', 'Alice', 'F', TO_DATE('1986-04-05', 'yyyy-mm-dd'), 'Daughter');
INSERT INTO DEPENDENT VALUES('333445555', 'Theodore', 'M', TO_DATE('1983-10-25', 'yyyy-mm-dd'), 'Son');
INSERT INTO DEPENDENT VALUES('333445555', 'Joy', 'F', TO_DATE('1958-05-03', 'yyyy-mm-dd'), 'Spouse');
INSERT INTO DEPENDENT VALUES('987654321', 'Abner', 'M', TO_DATE('1942-02-28', 'yyyy-mm-dd'), 'Spouse');
INSERT INTO DEPENDENT VALUES('123456789', 'Michael', 'M', TO_DATE('1988-01-03', 'yyyy-mm-dd'), 'Son');
INSERT INTO DEPENDENT VALUES('123456789', 'Alice', 'F', TO_DATE('1988-12-30', 'yyyy-mm-dd'), 'Daughter');
INSERT INTO DEPENDENT VALUES('123456789', 'Elizabeth', 'F', TO_DATE('1967-05-05', 'yyyy-mm-dd'), 'Spouse');

--COMMIT
COMMIT;

-- Lab #5-3
SELECT EMPLOYEE.Lname, EMPLOYEE.Minit, EMPLOYEE.Fname
FROM EMPLOYEE, WORKS_ON
WHERE Dno = 4
  AND Salary >= 25000
  AND Essn = Ssn
  AND Pno = 10
  ORDER BY Lname ASC;

SELECT DEPARTMENT.Dname, EMPLOYEE.Ssn, EMPLOYEE.Lname
FROM DEPARTMENT, EMPLOYEE
WHERE Super_ssn = '333445555'
  AND Address LIKE '%Houston%'
  AND Dno = Dnumber;
  
SELECT EMPLOYEE.Lname, WORKS_ON.Hours
FROM EMPLOYEE, WORKS_ON, PROJECT
WHERE Ssn = Essn
  AND Pno = Pnumber
  AND Pname = 'Newbenefits'
  ORDER BY Hours DESC;
  
SELECT EMPLOYEE.Fname, EMPLOYEE.Lname, WORKS_ON.Hours
FROM EMPLOYEE, WORKS_ON, PROJECT
WHERE Ssn = Essn
  AND Pno = Pnumber
  AND Pname = 'ProductY'
  AND Hours >= 10
  ORDER BY Hours ASC;
  
SELECT E.Lname, E.Fname, DEPENDENT.Dependent_name, DEPENDENT.Relationship
FROM EMPLOYEE E, DEPENDENT
WHERE DEPENDENT.Essn = E.Ssn
  AND E.Super_ssn = '123456789'

-- Lab #5-4
DELETE FROM DEPENDENT
WHERE 		Essn = '333445555';
SELECT * FROM DEPENDENT;

DELETE FROM DEPARTMENT
WHERE 		Dnumber = 4;
SELECT * FROM DEPARTMENT;
-- 테이블을 제작할 때 CASCADE 옵션을 넣지 않아서 삭제가 불가능. 무결성 제약조건 위반.

DELETE FROM WORKS_ON
WHERE 		Pno = 10;
SELECT * FROM WORKS_ON;

--ROLLBACK
ROLLBACK;

-- Lab #5-5
UPDATE PROJECT P
SET P.Plocation = 'Stafford'
WHERE P.Dnum = 5;
SELECT * FROM PROJECT WHERE Dnum = 5;

UPDATE EMPLOYEE E
SET E.Super_ssn = NULL
WHERE Ssn = '453453453';
SELECT * FROM EMPLOYEE WHERE Ssn = '453453453';

UPDATE DEPARTMENT D
SET D.Dname = 'Design'
WHERE Dnumber = 5;
SELECT * FROM DEPARTMENT WHERE Dnumber = 5;

--ROLLBACK
ROLLBACK;